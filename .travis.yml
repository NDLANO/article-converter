notifications:
  slack:
    on_success: change
    on_failure: always
    rooms:
      secure: t0GLfZHei4tE0ZfiHPoLBD0cjkFBPRLdpJJ9L4LNFJLBcnS4FoE1p3oCVUL1WoMCIjtPrdW3V6wiemggqbTxSZfA/aGEon2MrRU2H9YiRpeHCqHU0r2kAgGVhvE55ih/918FUHZENs98woJFtJMf8L54UCfc9QCd1FOkhctxyn8TEHlBYX0iO2sdz70+D0o8FGsoq8fS2Rvr9wnjrY8j9AwPz9uPEk/bntvphq4NRCHrdopbgeSGb6aR3QOlgD7nFmgqBQjuxqf/lP2YwR1HvywuJVKhRHPIDVNFQsOyQTMz4s8bweyXImx62ANY7wQ1O6WdVvtKwrv89N32iYuYHmlyHOfE6Dw2ryzunDmEPRjH6nHFiEzryZTvRimYWl567WKkDA7eHy8YxcdFJTqwsa53PlHFw91NHMupqaxc22L5xAcfFtlggw3CRTS6sYJgZxWcCNGzL1L/utzawmZ+9u54tlWb80XtN/PVgBukgdkUzgsfI2FHjA3CJXPfyYeSm666Z4y/OT4V//0zA1nBeeMlVkmVZz/SCsQAFG1M7IzqcJ9HULzIJL6xSldpSSsOAhtl7ynPyUQ1WVqSiZisIuL9pNmEhhqajgIZNug8sawkTlE2KqZNOJ57CdGVijqQB3C1m3A5u839Jfm7GS0V/lCH5KRNLLIp1L7vnIQc9Bg=
matrix:
  fast_finish: true
  include:
    - name: 'Tests'
      language: node_js
      node_js: '10'
      cache:
        yarn: true
        directories:
          - ~/.npm
          - .eslintcache
          - node_modules
      before_install:
        - curl -o- -L https://yarnpkg.com/install.sh | bash
        - export PATH="$HOME/.yarn/bin:$PATH"
      script:
        - yarn check-all
        - yarn build

    - name: "Release"
      language: python
      if: branch = master AND type = push
      python: 3.7
      dist: bionic
      services:
        - docker
      cache: pip
      before_install:
        # Authenticate docker client to deploy aws registry
        - pip install awscli
        - $(aws ecr get-login --no-include-email --region eu-west-1)

        # Fetch deploy repo
        - git clone --depth 1 https://knowit-at-ndla:$TRAVIS_RELEASE_GITHUB_TOKEN@github.com/ndlano/deploy.git ../deploy

        # Setup env
        - export NDLA_HOME=$(realpath $(pwd)/../)
        - export NDLA_DEPLOY=$NDLA_HOME/deploy
        - export DEPLOY_VERSION=$(git -C $NDLA_DEPLOY rev-parse --short=7 HEAD)
        - export DEPLOY_DOCKER_REPO=784120951859.dkr.ecr.eu-west-1.amazonaws.com/ndla/deploy

        # Get cache, and don't fail if missing
        - docker pull $DEPLOY_DOCKER_REPO:$DEPLOY_VERSION || true
      install:
        - eval "$($NDLA_DEPLOY/scripts/bin/ndla init -)"
      env:
        - SSH_AUTH_SOCK=/tmp/mock_sock
      script:
        - ndla release article-converter --update-chart

      before_cache: # Save docker image as cache
        - docker push $DEPLOY_DOCKER_REPO:$DEPLOY_VERSION

  allow_failures:
      - name: "Release"
    
